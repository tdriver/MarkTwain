name: CI

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Build solution (Release)
      run: msbuild MarkTwain.sln /p:Configuration=Release /p:Platform="Any CPU" /v:minimal

    - name: Copy DLL to output folder
      run: copy MarkTwain\bin\Release\MarkTwain.dll output\MarkTwain.dll

    # - name: Upload artifact
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: MarkTwain-dll
    #     path: output/MarkTwain.dll

    - name: Configure git
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Force add DLL to git
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: git add -f output/MarkTwain.dll

    - name: Commit DLL if changes exist
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: git diff --staged --quiet || git commit -m "Update MarkTwain.dll [skip ci]"

    - name: Push changes
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: git push
